{% extends "base.html" %}
{% block title %}新規リサーチ{% endblock %}

{% block content %}
<h1>新規リサーチ</h1>

{% if session_ok is defined and not session_ok %}
<div class="alert alert-error" style="background: #fff3cd; border-left: 4px solid #ffc107; color: #856404;">
    現在、1688リサーチ機能がメンテナンス中です。AIキーワードアシスタントは通常通りご利用いただけます。
</div>
{% endif %}
{% if error %}
<div class="alert alert-error">{{ error }}</div>
{% endif %}

{% if not usage_allowed %}
<div class="alert alert-error">{{ usage_message }}</div>
{% else %}

<!-- タブ切り替え -->
<div style="display: flex; gap: 0; margin-bottom: 0;">
    <button type="button" id="tab-batch" onclick="switchTab('batch')"
            style="border-radius: 8px 8px 0 0; border: 2px solid #1565c0; border-bottom: none; padding: 0.6rem 1.2rem; font-weight: bold; cursor: pointer; background: #1565c0; color: #fff;">
        一括オートリサーチ
    </button>
    <button type="button" id="tab-deep" onclick="switchTab('deep')"
            style="border-radius: 8px 8px 0 0; border: 2px solid #e65100; border-bottom: none; padding: 0.6rem 1.2rem; font-weight: bold; cursor: pointer; background: #fff; color: #e65100;">
        詳細オートリサーチ
    </button>
</div>

<!-- 一括オートリサーチ -->
<div class="card" id="panel-batch" style="border-top-left-radius: 0; border-top: 2px solid #1565c0;">
    <form method="post" action="/research/new" id="batch-form">
        <input type="hidden" name="research_type" value="batch">
        <div class="form-group">
            <label for="keyword-batch">キーワード（1行に1つ、最大{{ max_batch_size }}個）</label>
            <textarea id="keyword-batch" name="keyword" required
                      placeholder="スマホスタンド&#10;ワイヤレス充電器&#10;タブレットケース"
                      rows="6" style="width: 100%; resize: vertical; font-size: 1em; line-height: 1.6;"></textarea>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.25rem;">
                <small>各キーワードにつきサジェスト最大10個を順次オートリサーチ</small>
                <span id="batch-count" style="font-size: 0.85em; color: #666; font-weight: bold;">0 キーワード</span>
            </div>
        </div>
        <div class="form-group">
            <label for="batch-max-kw">サジェスト展開数（各キーワード）</label>
            <input type="number" id="batch-max-kw" name="auto_max_keywords"
                   value="10" min="1" max="50" style="width: 80px;">
            <small>各キーワードからサジェストを何個までリサーチするか</small>
        </div>
        <button type="submit" class="btn btn-primary" id="batch-submit-btn">一括リサーチ開始</button>
    </form>
</div>

<!-- 詳細オートリサーチ -->
<div class="card" id="panel-deep" style="display: none; border-top-left-radius: 0; border-top: 2px solid #e65100;">
    <form method="post" action="/research/new" id="deep-form">
        <input type="hidden" name="research_type" value="deep">
        <div class="form-group">
            <label for="keyword-deep">キーワード</label>
            <input type="text" id="keyword-deep" name="keyword" required
                   placeholder="例：スマホスタンド" style="width: 100%; font-size: 1em;">
            <small style="margin-top: 0.25rem; display: block;">
                1つのキーワードからサジェストを取得し、すべてオートリサーチします
            </small>
        </div>
        <div class="form-group">
            <label for="deep-max-kw">サジェスト展開数</label>
            <input type="number" id="deep-max-kw" name="auto_max_keywords"
                   value="30" min="1" max="100" style="width: 80px;">
            <small>サジェストを何個までリサーチするか</small>
        </div>
        <button type="submit" class="btn btn-primary">詳細リサーチ開始</button>
    </form>
</div>

<p class="mt-1 text-muted">
    今月のリサーチ数: {{ user.candidate_count_monthly }} / {{ user.candidate_limit_monthly }}
</p>

<div class="card mt-1">
    <h2>キーワード発見アシスタント</h2>
    <p class="text-muted" style="margin-bottom: .75rem;">AIがあなたの思いつかないキーワードを提案します。何でも聞いてみてください。</p>

    <div class="ai-chat-container" id="ai-chat-messages">
        <div class="ai-chat-message ai-chat-assistant">
            <div class="ai-chat-avatar ai-avatar-ai">AI</div>
            <div class="ai-chat-bubble">
                どんなジャンルに興味がある？<br>
                たとえばインテリア系、ペット系、ガーデニング系…ざっくりでOK！<br>
                完全におまかせもできるよ！
            </div>
        </div>
    </div>

    <div class="ai-chat-input-area">
        <div style="display: flex; gap: .5rem; align-items: flex-end;">
            <textarea id="ai-chat-input" class="ai-chat-input"
                      placeholder="メッセージを入力..."
                      rows="2" autocomplete="off"></textarea>
            <button type="button" id="ai-chat-send" class="btn btn-primary ai-chat-send-btn" onclick="aiChatSend()">送信</button>
        </div>
        <div style="display: flex; gap: .5rem; margin-top: .5rem;">
            <button type="button" class="btn btn-outline btn-sm" onclick="aiChatOmakase()">おまかせで提案</button>
            <button type="button" class="btn btn-outline btn-sm" onclick="aiChatReset()">リセット</button>
        </div>
    </div>
</div>

{% if saved_keywords %}
<div class="card mt-1">
    <h2>保存済みキーワード</h2>
    <table class="table">
        <thead>
            <tr>
                <th>キーワード</th>
                <th>保存日時</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
        {% for kw in saved_keywords %}
            <tr>
                <td>{{ kw.keyword }}</td>
                <td>{{ kw.created_at|jst }}</td>
                <td style="white-space: nowrap;">
                    <button class="btn btn-sm btn-primary" onclick="useKeyword('{{ kw.keyword }}')">使用</button>
                    <form method="post" action="/research/keywords/{{ kw.id }}/delete" style="display: inline;"
                          onsubmit="return confirm('削除しますか？')">
                        <button class="btn btn-sm btn-outline" type="submit">削除</button>
                    </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<script>
/* --- Tab switching --- */
var currentTab = 'batch';

function switchTab(tab) {
    currentTab = tab;
    document.getElementById('panel-batch').style.display = tab === 'batch' ? 'block' : 'none';
    document.getElementById('panel-deep').style.display = tab === 'deep' ? 'block' : 'none';

    var tabBatch = document.getElementById('tab-batch');
    var tabDeep = document.getElementById('tab-deep');

    if (tab === 'batch') {
        tabBatch.style.background = '#1565c0';
        tabBatch.style.color = '#fff';
        tabDeep.style.background = '#fff';
        tabDeep.style.color = '#e65100';
        document.getElementById('keyword-batch').focus();
    } else {
        tabDeep.style.background = '#e65100';
        tabDeep.style.color = '#fff';
        tabBatch.style.background = '#fff';
        tabBatch.style.color = '#1565c0';
        document.getElementById('keyword-deep').focus();
    }
}

/* --- Batch keyword count --- */
var batchTextarea = document.getElementById('keyword-batch');
var batchCount = document.getElementById('batch-count');
var batchSubmitBtn = document.getElementById('batch-submit-btn');

function updateBatchCount() {
    var lines = batchTextarea.value.split('\n');
    var count = 0;
    var seen = {};
    for (var i = 0; i < lines.length; i++) {
        var kw = lines[i].trim();
        if (kw && !seen[kw]) {
            seen[kw] = true;
            count++;
        }
    }
    batchCount.textContent = count + ' キーワード';
    if (count > 1) {
        batchSubmitBtn.textContent = '一括リサーチ開始（' + count + '件）';
    } else {
        batchSubmitBtn.textContent = '一括リサーチ開始';
    }
}

batchTextarea.addEventListener('input', updateBatchCount);
updateBatchCount();

/* --- useKeyword: active tab aware --- */
function useKeyword(kw) {
    if (currentTab === 'batch') {
        var current = batchTextarea.value.trim();
        if (current) {
            batchTextarea.value = current + '\n' + kw;
        } else {
            batchTextarea.value = kw;
        }
        updateBatchCount();
        batchTextarea.focus();
    } else {
        document.getElementById('keyword-deep').value = kw;
        document.getElementById('keyword-deep').focus();
    }
    window.scrollTo({top: 0, behavior: 'smooth'});
}

function saveKeyword() {
    var kw;
    if (currentTab === 'batch') {
        kw = batchTextarea.value.trim().split('\n')[0].trim();
    } else {
        kw = document.getElementById('keyword-deep').value.trim();
    }
    if (!kw) { alert('キーワードを入力してください'); return; }
    var form = document.createElement('form');
    form.method = 'POST';
    form.action = '/research/keywords/save';
    var input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'keyword';
    input.value = kw;
    form.appendChild(input);
    document.body.appendChild(form);
    form.submit();
}

/* --- AI Chat --- */
var aiChatHistory = [];
var aiChatBusy = false;

function aiChatScrollBottom() {
    var c = document.getElementById('ai-chat-messages');
    c.scrollTop = c.scrollHeight;
}

function aiChatAddMessage(role, html) {
    var container = document.getElementById('ai-chat-messages');
    var div = document.createElement('div');
    div.className = 'ai-chat-message ' + (role === 'user' ? 'ai-chat-user' : 'ai-chat-assistant');

    var avatar = document.createElement('div');
    avatar.className = 'ai-chat-avatar ' + (role === 'user' ? 'ai-avatar-you' : 'ai-avatar-ai');
    avatar.textContent = role === 'user' ? 'You' : 'AI';

    var bubble = document.createElement('div');
    bubble.className = 'ai-chat-bubble';
    bubble.innerHTML = html;

    div.appendChild(avatar);
    div.appendChild(bubble);
    container.appendChild(div);
    aiChatScrollBottom();
    return bubble;
}

function aiChatParseKeywords(text) {
    return text.replace(/\[KW\](.*?)\[\/KW\]/g, function(match, kw) {
        var escaped = kw.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        return '<strong class="ai-chat-kw-name">' + kw + '</strong>' +
               ' <button class="btn btn-sm btn-primary ai-chat-keyword-btn" ' +
               'onclick="useKeyword(\'' + escaped + '\')"' +
               '>このキーワードを使う</button>';
    });
}

async function aiChatSend(overrideMessage) {
    if (aiChatBusy) return;

    var input = document.getElementById('ai-chat-input');
    var message = overrideMessage || input.value.trim();
    if (!message) return;

    aiChatBusy = true;
    input.value = '';
    document.getElementById('ai-chat-send').disabled = true;

    aiChatAddMessage('user', message.replace(/</g, '&lt;').replace(/>/g, '&gt;'));

    var assistantBubble = aiChatAddMessage('assistant', '<span class="ai-chat-loading"><span class="ai-chat-dot"></span><span class="ai-chat-dot"></span><span class="ai-chat-dot"></span></span>');

    try {
        var response = await fetch('/research/discovery/ai-chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                message: message,
                history: aiChatHistory
            })
        });

        if (!response.ok) {
            assistantBubble.innerHTML = 'エラーが発生しました。もう一度お試しください。';
            aiChatBusy = false;
            document.getElementById('ai-chat-send').disabled = false;
            return;
        }

        var reader = response.body.getReader();
        var decoder = new TextDecoder();
        var fullText = '';
        assistantBubble.innerHTML = '';

        while (true) {
            var result = await reader.read();
            if (result.done) break;

            var text = decoder.decode(result.value, {stream: true});
            var lines = text.split('\n');

            for (var i = 0; i < lines.length; i++) {
                var line = lines[i].trim();
                if (!line.startsWith('data: ')) continue;

                try {
                    var data = JSON.parse(line.substring(6));
                    if (data.done) break;
                    if (data.error) {
                        assistantBubble.innerHTML = data.error;
                        break;
                    }
                    if (data.chunk) {
                        fullText += data.chunk;
                        assistantBubble.innerHTML = aiChatParseKeywords(
                            fullText.replace(/</g, '&lt;').replace(/>/g, '&gt;')
                                    .replace(/\n/g, '<br>')
                        );
                        aiChatScrollBottom();
                    }
                } catch(e) {}
            }
        }

        assistantBubble.innerHTML = aiChatParseKeywords(
            fullText.replace(/</g, '&lt;').replace(/>/g, '&gt;')
                    .replace(/\n/g, '<br>')
        );

        aiChatHistory.push({role: 'user', content: message});
        aiChatHistory.push({role: 'assistant', content: fullText});

    } catch(e) {
        assistantBubble.innerHTML = '通信エラーが発生しました。もう一度お試しください。';
    }

    aiChatBusy = false;
    document.getElementById('ai-chat-send').disabled = false;
    input.focus();
}

function aiChatOmakase() {
    aiChatSend('何でもいいので、意外性のあるニッチなキーワードをおまかせで提案してください。ジャンルは完全にあなたにお任せします。');
}

function aiChatReset() {
    aiChatHistory = [];
    var container = document.getElementById('ai-chat-messages');
    container.innerHTML = '<div class="ai-chat-message ai-chat-assistant">' +
        '<div class="ai-chat-avatar ai-avatar-ai">AI</div>' +
        '<div class="ai-chat-bubble">' +
        'どんなジャンルに興味がある？<br>' +
        'たとえばインテリア系、ペット系、ガーデニング系…ざっくりでOK！<br>' +
        '完全におまかせもできるよ！' +
        '</div></div>';
}

var aiInput = document.getElementById('ai-chat-input');
aiInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        aiChatSend();
    }
});
aiInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 160) + 'px';
});
</script>
{% endif %}
{% endblock %}
