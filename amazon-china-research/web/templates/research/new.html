{% extends "base.html" %}
{% block title %}æ–°è¦ãƒªã‚µãƒ¼ãƒ{% endblock %}

{% block content %}
<h1>æ–°è¦ãƒªã‚µãƒ¼ãƒ</h1>

{% if session_ok is defined and not session_ok %}
<div class="alert alert-error" style="background: #fff3cd; border-left: 4px solid #ffc107; color: #856404;">
    1688ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒé€£æºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<a href="/account/settings" style="color: #856404; font-weight: bold;">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š</a>ã‹ã‚‰é€£æºã—ã¦ãã ã•ã„ã€‚AIã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã¯é€šå¸¸é€šã‚Šã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚
</div>
{% endif %}
{% if error %}
<div class="alert alert-error">{{ error }}</div>
{% endif %}

{% if not usage_allowed %}
<div class="alert alert-error">{{ usage_message }}</div>
{% else %}

<!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
<div style="display: flex; gap: 0; margin-bottom: 0;">
    <button type="button" id="tab-batch" onclick="switchTab('batch')"
            style="border-radius: 8px 8px 0 0; border: 2px solid #1565c0; border-bottom: none; padding: 0.6rem 1.2rem; font-weight: bold; cursor: pointer; background: #1565c0; color: #fff;">
        ä¸€æ‹¬ã‚ªãƒ¼ãƒˆãƒªã‚µãƒ¼ãƒ
    </button>
    <button type="button" id="tab-deep" onclick="switchTab('deep')"
            style="border-radius: 8px 8px 0 0; border: 2px solid #e65100; border-bottom: none; padding: 0.6rem 1.2rem; font-weight: bold; cursor: pointer; background: #fff; color: #e65100;">
        è©³ç´°ã‚ªãƒ¼ãƒˆãƒªã‚µãƒ¼ãƒ
    </button>
</div>

<!-- ä¸€æ‹¬ã‚ªãƒ¼ãƒˆãƒªã‚µãƒ¼ãƒ -->
<div class="card" id="panel-batch" style="border-top-left-radius: 0; border-top: 2px solid #1565c0;">
    <form method="post" action="/research/new" id="batch-form">
        <input type="hidden" name="research_type" value="batch">
        <div class="form-group">
            <label for="keyword-batch">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆ1è¡Œã«1ã¤ã€æœ€å¤§{{ max_batch_size }}å€‹ï¼‰</label>
            <textarea id="keyword-batch" name="keyword" required
                      placeholder="ã‚¹ãƒãƒ›ã‚¹ã‚¿ãƒ³ãƒ‰&#10;ãƒ¯ã‚¤ãƒ¤ãƒ¬ã‚¹å……é›»å™¨&#10;ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã‚±ãƒ¼ã‚¹"
                      rows="6" style="width: 100%; resize: vertical; font-size: 1em; line-height: 1.6;"></textarea>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.25rem;">
                <small>å„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ã¤ãã‚µã‚¸ã‚§ã‚¹ãƒˆæœ€å¤§10å€‹ã‚’é †æ¬¡ã‚ªãƒ¼ãƒˆãƒªã‚µãƒ¼ãƒ</small>
                <span id="batch-count" style="font-size: 0.85em; color: #666; font-weight: bold;">0 ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</span>
            </div>
        </div>
        <div class="form-group">
            <label for="batch-max-kw">ã‚µã‚¸ã‚§ã‚¹ãƒˆå±•é–‹æ•°ï¼ˆå„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‰</label>
            <input type="number" id="batch-max-kw" name="auto_max_keywords"
                   value="10" min="1" max="50" style="width: 80px;">
            <small>å„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‹ã‚‰ã‚µã‚¸ã‚§ã‚¹ãƒˆã‚’ä½•å€‹ã¾ã§ãƒªã‚µãƒ¼ãƒã™ã‚‹ã‹</small>
        </div>
        <button type="submit" class="btn btn-primary" id="batch-submit-btn">ä¸€æ‹¬ãƒªã‚µãƒ¼ãƒé–‹å§‹</button>
    </form>
</div>

<!-- è©³ç´°ã‚ªãƒ¼ãƒˆãƒªã‚µãƒ¼ãƒ -->
<div class="card" id="panel-deep" style="display: none; border-top-left-radius: 0; border-top: 2px solid #e65100;">
    <form method="post" action="/research/new" id="deep-form">
        <input type="hidden" name="research_type" value="deep">
        <div class="form-group">
            <label for="keyword-deep">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="text" id="keyword-deep" name="keyword" required
                   placeholder="ä¾‹ï¼šã‚¹ãƒãƒ›ã‚¹ã‚¿ãƒ³ãƒ‰" style="width: 100%; font-size: 1em;">
            <small style="margin-top: 0.25rem; display: block;">
                1ã¤ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‹ã‚‰ã‚µã‚¸ã‚§ã‚¹ãƒˆã‚’å–å¾—ã—ã€ã™ã¹ã¦ã‚ªãƒ¼ãƒˆãƒªã‚µãƒ¼ãƒã—ã¾ã™
            </small>
        </div>
        <div class="form-group">
            <label for="deep-max-kw">ã‚µã‚¸ã‚§ã‚¹ãƒˆå±•é–‹æ•°</label>
            <input type="number" id="deep-max-kw" name="auto_max_keywords"
                   value="30" min="1" max="100" style="width: 80px;">
            <small>ã‚µã‚¸ã‚§ã‚¹ãƒˆã‚’ä½•å€‹ã¾ã§ãƒªã‚µãƒ¼ãƒã™ã‚‹ã‹</small>
        </div>
        <button type="submit" class="btn btn-primary">è©³ç´°ãƒªã‚µãƒ¼ãƒé–‹å§‹</button>
    </form>
</div>

<p class="mt-1 text-muted">
    ä»Šæœˆã®ãƒªã‚µãƒ¼ãƒæ•°: {{ user.candidate_count_monthly }} / {{ user.candidate_limit_monthly }}
</p>

<div class="card mt-1">
    <h2>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç™ºè¦‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</h2>
    <p class="text-muted" style="margin-bottom: .75rem;">AIãŒã‚ãªãŸã®æ€ã„ã¤ã‹ãªã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ææ¡ˆã—ã¾ã™ã€‚ä½•ã§ã‚‚èã„ã¦ã¿ã¦ãã ã•ã„ã€‚</p>

    <style>
    .ai-cat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: .5rem; margin: .5rem 0; }
    @media (max-width: 600px) { .ai-cat-grid { grid-template-columns: 1fr; } }
    .ai-cat-btn {
        display: flex; align-items: center; gap: .5rem;
        padding: .6rem .8rem; border: 2px solid #e0e0e0; border-radius: 8px;
        background: #fff; cursor: pointer; font-size: .95em; font-weight: 500;
        transition: all .15s; text-align: left; color: #333;
    }
    .ai-cat-btn:hover { border-color: #1565c0; background: #e3f2fd; color: #1565c0; }
    .ai-cat-btn .ai-cat-emoji { font-size: 1.3em; flex-shrink: 0; }
    .ai-cat-breadcrumb {
        display: flex; flex-wrap: wrap; align-items: center; gap: .25rem;
        margin-bottom: .5rem; font-size: .85em; color: #666;
    }
    .ai-cat-breadcrumb span { cursor: pointer; color: #1565c0; text-decoration: underline; }
    .ai-cat-breadcrumb span:last-child { color: #333; font-weight: bold; text-decoration: none; cursor: default; }
    .ai-cat-back-btn {
        display: inline-flex; align-items: center; gap: .3rem;
        padding: .3rem .6rem; border: 1px solid #ccc; border-radius: 6px;
        background: #f5f5f5; cursor: pointer; font-size: .85em; color: #555;
        margin-bottom: .5rem;
    }
    .ai-cat-back-btn:hover { background: #e0e0e0; }
    .ai-cat-start-btn {
        display: block; width: 100%; padding: .7rem; margin-top: .5rem;
        border: 2px solid #1565c0; border-radius: 8px; background: #1565c0;
        color: #fff; font-size: 1em; font-weight: bold; cursor: pointer;
        transition: all .15s;
    }
    .ai-cat-start-btn:hover { background: #0d47a1; }
    </style>
    <div class="ai-chat-container" id="ai-chat-messages">
        <div class="ai-chat-message ai-chat-assistant">
            <div class="ai-chat-avatar ai-avatar-ai">AI</div>
            <div class="ai-chat-bubble" id="ai-init-categories">
                ã¾ãšã¯ã©ã®ã‚¸ãƒ£ãƒ³ãƒ«ã§æ”»ã‚ãŸã„ã‹ã€ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ã¿ã¦ï¼
                <div class="ai-cat-grid">
                    <button type="button" class="ai-cat-btn" onclick="aiChatSelectCategory('DIYãƒ»å·¥å…·ãƒ»ã‚¬ãƒ¼ãƒ‡ãƒ³')"><span class="ai-cat-emoji">ğŸ”§</span> DIYãƒ»å·¥å…·ãƒ»ã‚¬ãƒ¼ãƒ‡ãƒ³</button>
                    <button type="button" class="ai-cat-btn" onclick="aiChatSelectCategory('ãŠã‚‚ã¡ã‚ƒ')"><span class="ai-cat-emoji">ğŸ§¸</span> ãŠã‚‚ã¡ã‚ƒ</button>
                    <button type="button" class="ai-cat-btn" onclick="aiChatSelectCategory('ã‚¹ãƒãƒ¼ãƒ„ï¼†ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢')"><span class="ai-cat-emoji">â›º</span> ã‚¹ãƒãƒ¼ãƒ„ï¼†ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢</button>
                    <button type="button" class="ai-cat-btn" onclick="aiChatSelectCategory('ãƒšãƒƒãƒˆç”¨å“')"><span class="ai-cat-emoji">ğŸ¾</span> ãƒšãƒƒãƒˆç”¨å“</button>
                    <button type="button" class="ai-cat-btn" onclick="aiChatSelectCategory('ãƒ™ãƒ“ãƒ¼ï¼†ãƒã‚¿ãƒ‹ãƒ†ã‚£')"><span class="ai-cat-emoji">ğŸ‘¶</span> ãƒ™ãƒ“ãƒ¼ï¼†ãƒã‚¿ãƒ‹ãƒ†ã‚£</button>
                    <button type="button" class="ai-cat-btn" onclick="aiChatSelectCategory('ãƒ›ãƒ¼ãƒ ï¼†ã‚­ãƒƒãƒãƒ³')"><span class="ai-cat-emoji">ğŸ </span> ãƒ›ãƒ¼ãƒ ï¼†ã‚­ãƒƒãƒãƒ³</button>
                    <button type="button" class="ai-cat-btn" onclick="aiChatSelectCategory('ãƒ›ãƒ“ãƒ¼')"><span class="ai-cat-emoji">ğŸ¨</span> ãƒ›ãƒ“ãƒ¼</button>
                    <button type="button" class="ai-cat-btn" onclick="aiChatSelectCategory('æ–‡æˆ¿å…·ãƒ»ã‚ªãƒ•ã‚£ã‚¹ç”¨å“')"><span class="ai-cat-emoji">âœï¸</span> æ–‡æˆ¿å…·ãƒ»ã‚ªãƒ•ã‚£ã‚¹ç”¨å“</button>
                    <button type="button" class="ai-cat-btn" onclick="aiChatSelectCategory('ç”£æ¥­ãƒ»ç ”ç©¶é–‹ç™ºç”¨å“')"><span class="ai-cat-emoji">ğŸ”¬</span> ç”£æ¥­ãƒ»ç ”ç©¶é–‹ç™ºç”¨å“</button>
                    <button type="button" class="ai-cat-btn" onclick="aiChatSelectCategory('è»Šï¼†ãƒã‚¤ã‚¯')"><span class="ai-cat-emoji">ğŸš—</span> è»Šï¼†ãƒã‚¤ã‚¯</button>
                </div>
                <small style="color: #888;">ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ã‚‚ã„ã„ã—ã€è‡ªåˆ†ã§å…¥åŠ›ã—ã¦ã‚‚OKã ã‚ˆï¼</small>
            </div>
        </div>
    </div>

    <div class="ai-chat-input-area">
        <div style="display: flex; gap: .5rem; align-items: flex-end;">
            <textarea id="ai-chat-input" class="ai-chat-input"
                      placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
                      rows="2" autocomplete="off"></textarea>
            <button type="button" id="ai-chat-send" class="btn btn-primary ai-chat-send-btn" onclick="aiChatSend()">é€ä¿¡</button>
        </div>
        <div style="display: flex; gap: .5rem; margin-top: .5rem;">
            <button type="button" class="btn btn-outline btn-sm" onclick="aiChatOmakase()">ãŠã¾ã‹ã›ã§ææ¡ˆ</button>
            <button type="button" class="btn btn-outline btn-sm" onclick="aiChatReset()">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>
</div>

{% if saved_keywords %}
<div class="card mt-1">
    <h2>ä¿å­˜æ¸ˆã¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</h2>
    <table class="table">
        <thead>
            <tr>
                <th>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</th>
                <th>ä¿å­˜æ—¥æ™‚</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
        {% for kw in saved_keywords %}
            <tr>
                <td>{{ kw.keyword }}</td>
                <td>{{ kw.created_at|jst }}</td>
                <td style="white-space: nowrap;">
                    <button class="btn btn-sm btn-primary" onclick="useKeyword('{{ kw.keyword }}')">ä½¿ç”¨</button>
                    <form method="post" action="/research/keywords/{{ kw.id }}/delete" style="display: inline;"
                          onsubmit="return confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')">
                        <button class="btn btn-sm btn-outline" type="submit">å‰Šé™¤</button>
                    </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<script>
/* --- Tab switching --- */
var currentTab = 'batch';

function switchTab(tab) {
    currentTab = tab;
    document.getElementById('panel-batch').style.display = tab === 'batch' ? 'block' : 'none';
    document.getElementById('panel-deep').style.display = tab === 'deep' ? 'block' : 'none';

    var tabBatch = document.getElementById('tab-batch');
    var tabDeep = document.getElementById('tab-deep');

    if (tab === 'batch') {
        tabBatch.style.background = '#1565c0';
        tabBatch.style.color = '#fff';
        tabDeep.style.background = '#fff';
        tabDeep.style.color = '#e65100';
        document.getElementById('keyword-batch').focus();
    } else {
        tabDeep.style.background = '#e65100';
        tabDeep.style.color = '#fff';
        tabBatch.style.background = '#fff';
        tabBatch.style.color = '#1565c0';
        document.getElementById('keyword-deep').focus();
    }
}

/* --- Batch keyword count --- */
var batchTextarea = document.getElementById('keyword-batch');
var batchCount = document.getElementById('batch-count');
var batchSubmitBtn = document.getElementById('batch-submit-btn');

function updateBatchCount() {
    var lines = batchTextarea.value.split('\n');
    var count = 0;
    var seen = {};
    for (var i = 0; i < lines.length; i++) {
        var kw = lines[i].trim();
        if (kw && !seen[kw]) {
            seen[kw] = true;
            count++;
        }
    }
    batchCount.textContent = count + ' ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰';
    if (count > 1) {
        batchSubmitBtn.textContent = 'ä¸€æ‹¬ãƒªã‚µãƒ¼ãƒé–‹å§‹ï¼ˆ' + count + 'ä»¶ï¼‰';
    } else {
        batchSubmitBtn.textContent = 'ä¸€æ‹¬ãƒªã‚µãƒ¼ãƒé–‹å§‹';
    }
}

batchTextarea.addEventListener('input', updateBatchCount);
updateBatchCount();

/* --- useKeyword: active tab aware --- */
function useKeyword(kw) {
    if (currentTab === 'batch') {
        var current = batchTextarea.value.trim();
        if (current) {
            batchTextarea.value = current + '\n' + kw;
        } else {
            batchTextarea.value = kw;
        }
        updateBatchCount();
        batchTextarea.focus();
    } else {
        document.getElementById('keyword-deep').value = kw;
        document.getElementById('keyword-deep').focus();
    }
    window.scrollTo({top: 0, behavior: 'smooth'});
}

function saveKeyword() {
    var kw;
    if (currentTab === 'batch') {
        kw = batchTextarea.value.trim().split('\n')[0].trim();
    } else {
        kw = document.getElementById('keyword-deep').value.trim();
    }
    if (!kw) { alert('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    var form = document.createElement('form');
    form.method = 'POST';
    form.action = '/research/keywords/save';
    var input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'keyword';
    input.value = kw;
    form.appendChild(input);
    document.body.appendChild(form);
    form.submit();
}

/* --- AI Chat --- */
var aiChatHistory = [];
var aiChatBusy = false;
var _categoryTree = null;    // Amazonã‚«ãƒ†ã‚´ãƒªãƒ„ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿
var _categoryPath = [];      // ç¾åœ¨ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ã‚¹ [{name, children}]

var _catEmojis = {
    'DIYãƒ»å·¥å…·ãƒ»ã‚¬ãƒ¼ãƒ‡ãƒ³': 'ğŸ”§', 'ãŠã‚‚ã¡ã‚ƒ': 'ğŸ§¸',
    'ã‚¹ãƒãƒ¼ãƒ„ï¼†ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢': 'â›º', 'ãƒšãƒƒãƒˆç”¨å“': 'ğŸ¾',
    'ãƒ™ãƒ“ãƒ¼ï¼†ãƒã‚¿ãƒ‹ãƒ†ã‚£': 'ğŸ‘¶', 'ãƒ›ãƒ¼ãƒ ï¼†ã‚­ãƒƒãƒãƒ³': 'ğŸ ',
    'ãƒ›ãƒ“ãƒ¼': 'ğŸ¨', 'æ–‡æˆ¿å…·ãƒ»ã‚ªãƒ•ã‚£ã‚¹ç”¨å“': 'âœï¸',
    'ç”£æ¥­ãƒ»ç ”ç©¶é–‹ç™ºç”¨å“': 'ğŸ”¬', 'è»Šï¼†ãƒã‚¤ã‚¯': 'ğŸš—'
};

/* ã‚«ãƒ†ã‚´ãƒªãƒ„ãƒªãƒ¼JSONã‚’ãƒ­ãƒ¼ãƒ‰ */
(function loadCategoryTree() {
    fetch('/static/data/amazon_categories.json')
        .then(function(r) { return r.ok ? r.json() : null; })
        .then(function(data) { if (data) _categoryTree = data; })
        .catch(function() {});
})();

function aiChatScrollBottom() {
    var c = document.getElementById('ai-chat-messages');
    c.scrollTop = c.scrollHeight;
}

function aiChatAddMessage(role, html) {
    var container = document.getElementById('ai-chat-messages');
    var div = document.createElement('div');
    div.className = 'ai-chat-message ' + (role === 'user' ? 'ai-chat-user' : 'ai-chat-assistant');

    var avatar = document.createElement('div');
    avatar.className = 'ai-chat-avatar ' + (role === 'user' ? 'ai-avatar-you' : 'ai-avatar-ai');
    avatar.textContent = role === 'user' ? 'You' : 'AI';

    var bubble = document.createElement('div');
    bubble.className = 'ai-chat-bubble';
    bubble.innerHTML = html;

    div.appendChild(avatar);
    div.appendChild(bubble);
    container.appendChild(div);
    aiChatScrollBottom();
    return bubble;
}

function aiChatParseKeywords(text) {
    // Handle [KW:NG], [KW:WARN], and [KW] tags
    return text.replace(/\[KW(?::(NG|WARN))?\](.*?)\[\/KW\]/g, function(match, tag, kw) {
        var escaped = kw.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        var nameClass = 'ai-chat-kw-name';
        var rowClass = 'ai-chat-kw-row';
        var label = '';
        if (tag === 'NG') {
            nameClass += ' kw-ng';
            rowClass += ' kw-ng-row';
            label = ' <span style="color:#0d6efd;font-size:.75rem;font-weight:600">â›” ãƒªã‚µãƒ¼ãƒç¦æ­¢</span>';
        } else if (tag === 'WARN') {
            nameClass += ' kw-warn';
            rowClass += ' kw-warn-row';
            label = ' <span style="color:#dc3545;font-size:.75rem;font-weight:600">âš  é¡ä¼¼å“å¤šã„</span>';
        }
        var buttons = '';
        if (!tag) {
            // Normal keywords get action buttons
            buttons = ' <button class="btn btn-sm btn-primary ai-chat-keyword-btn" ' +
                      'onclick="useKeyword(\'' + escaped + '\')"' +
                      '>ã“ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ã†</button>' +
                      ' <button class="btn btn-sm ai-chat-expand-btn" ' +
                      'onclick="expandKeyword(\'' + escaped + '\', this)"' +
                      '>æ‹¡å¼µã™ã‚‹</button>';
        } else {
            // NG/WARN keywords only get expand button (no "use" button)
            buttons = ' <button class="btn btn-sm ai-chat-expand-btn" ' +
                      'onclick="expandKeyword(\'' + escaped + '\', this)"' +
                      '>æ‹¡å¼µã™ã‚‹</button>';
        }
        return '<span class="' + rowClass + '">' +
               '<strong class="' + nameClass + '">' + kw + '</strong>' +
               label + buttons +
               '</span>';
    });
}

async function aiChatSend(overrideMessage) {
    if (aiChatBusy) return;

    var input = document.getElementById('ai-chat-input');
    var message = overrideMessage || input.value.trim();
    if (!message) return;

    aiChatBusy = true;
    input.value = '';
    document.getElementById('ai-chat-send').disabled = true;

    aiChatAddMessage('user', message.replace(/</g, '&lt;').replace(/>/g, '&gt;'));

    var assistantBubble = aiChatAddMessage('assistant', '<span class="ai-chat-loading"><span class="ai-chat-dot"></span><span class="ai-chat-dot"></span><span class="ai-chat-dot"></span></span>');

    try {
        var response = await fetch('/research/discovery/ai-chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                message: message,
                history: aiChatHistory
            })
        });

        if (!response.ok) {
            assistantBubble.innerHTML = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
            aiChatBusy = false;
            document.getElementById('ai-chat-send').disabled = false;
            return;
        }

        var reader = response.body.getReader();
        var decoder = new TextDecoder();
        var fullText = '';
        assistantBubble.innerHTML = '';

        while (true) {
            var result = await reader.read();
            if (result.done) break;

            var text = decoder.decode(result.value, {stream: true});
            var lines = text.split('\n');

            for (var i = 0; i < lines.length; i++) {
                var line = lines[i].trim();
                if (!line.startsWith('data: ')) continue;

                try {
                    var data = JSON.parse(line.substring(6));
                    if (data.done) break;
                    if (data.error) {
                        assistantBubble.innerHTML = data.error;
                        break;
                    }
                    if (data.chunk) {
                        fullText += data.chunk;
                        assistantBubble.innerHTML = aiChatParseKeywords(
                            fullText.replace(/</g, '&lt;').replace(/>/g, '&gt;')
                                    .replace(/\n/g, '<br>')
                        );
                        aiChatScrollBottom();
                    }
                } catch(e) {}
            }
        }

        assistantBubble.innerHTML = aiChatParseKeywords(
            fullText.replace(/</g, '&lt;').replace(/>/g, '&gt;')
                    .replace(/\n/g, '<br>')
        );

        aiChatHistory.push({role: 'user', content: message});
        aiChatHistory.push({role: 'assistant', content: fullText});

    } catch(e) {
        assistantBubble.innerHTML = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
    }

    aiChatBusy = false;
    document.getElementById('ai-chat-send').disabled = false;
    input.focus();
}

/* --- ã‚«ãƒ†ã‚´ãƒªãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ --- */

function _buildBreadcrumb() {
    if (_categoryPath.length === 0) return '';
    var html = '<div class="ai-cat-breadcrumb">';
    html += '<span onclick="aiCatNavigateTo(-1)">ãƒˆãƒƒãƒ—</span>';
    for (var i = 0; i < _categoryPath.length; i++) {
        html += ' &gt; ';
        if (i < _categoryPath.length - 1) {
            html += '<span onclick="aiCatNavigateTo(' + i + ')">' + _categoryPath[i].name + '</span>';
        } else {
            html += '<span>' + _categoryPath[i].name + '</span>';
        }
    }
    html += '</div>';
    return html;
}

function _buildSubcategoryButtons(children) {
    var html = '<div class="ai-cat-grid">';
    for (var i = 0; i < children.length; i++) {
        var ch = children[i];
        var escaped = ch.name.replace(/'/g, "\\'");
        html += '<button type="button" class="ai-cat-btn" onclick="aiCatDrillDown(\'' + escaped + '\')">';
        var hasKids = ch.children && ch.children.length > 0;
        html += '<span style="font-size:.85em;color:#888;">' + (hasKids ? 'ğŸ“‚' : 'ğŸ“„') + '</span> ' + ch.name;
        if (hasKids) html += ' <span style="font-size:.75em;color:#aaa;">(' + ch.children.length + ')</span>';
        html += '</button>';
    }
    html += '</div>';
    return html;
}

function _renderCategoryNav() {
    var initEl = document.getElementById('ai-init-categories');
    if (!initEl) return;

    var currentChildren;
    if (_categoryPath.length === 0) {
        // ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«: ãƒ¡ã‚¤ãƒ³ã‚«ãƒ†ã‚´ãƒªãƒœã‚¿ãƒ³
        initEl.innerHTML = _buildMainCatGrid();
        return;
    }

    var lastNode = _categoryPath[_categoryPath.length - 1];
    currentChildren = lastNode.children || [];

    var html = _buildBreadcrumb();
    html += '<button type="button" class="ai-cat-back-btn" onclick="aiCatGoBack()">â† æˆ»ã‚‹</button>';

    if (currentChildren.length > 0) {
        html += '<div style="margin-bottom:.5rem;color:#555;">ã€Œ<strong>' + lastNode.name + '</strong>ã€ã®ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ã­ï¼š</div>';
        html += _buildSubcategoryButtons(currentChildren);
        html += '<button type="button" class="ai-cat-start-btn" onclick="aiCatStartChat()">ã€Œ' + lastNode.name + 'ã€ã§ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ææ¡ˆã‚’é–‹å§‹</button>';
    } else {
        html += '<div style="margin-bottom:.5rem;">âœ… <strong>' + lastNode.name + '</strong> ã‚’é¸æŠ</div>';
        html += '<button type="button" class="ai-cat-start-btn" onclick="aiCatStartChat()">ã“ã®ã‚«ãƒ†ã‚´ãƒªã§ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ææ¡ˆã‚’é–‹å§‹</button>';
    }

    initEl.innerHTML = html;
}

function _findCategoryNode(name, tree) {
    for (var i = 0; i < tree.length; i++) {
        if (tree[i].name === name) return tree[i];
    }
    return null;
}

function aiChatSelectCategory(category) {
    // ãƒ¡ã‚¤ãƒ³ã‚«ãƒ†ã‚´ãƒªé¸æŠ: ãƒ„ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³
    if (_categoryTree) {
        var node = _findCategoryNode(category, _categoryTree);
        if (node && node.children && node.children.length > 0) {
            _categoryPath = [{name: node.name, children: node.children}];
            _renderCategoryNav();
            return;
        }
    }
    // ãƒ„ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯AIã«ç›´æ¥é€ä¿¡ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    _categoryPath = [{name: category, children: []}];
    aiCatStartChat();
}

function aiCatDrillDown(name) {
    if (_categoryPath.length === 0) return;
    var lastNode = _categoryPath[_categoryPath.length - 1];
    var child = _findCategoryNode(name, lastNode.children || []);
    if (child) {
        _categoryPath.push({name: child.name, children: child.children || []});
        _renderCategoryNav();
    }
}

function aiCatGoBack() {
    if (_categoryPath.length > 1) {
        _categoryPath.pop();
        _renderCategoryNav();
    } else {
        _categoryPath = [];
        _renderCategoryNav();
    }
}

function aiCatNavigateTo(index) {
    if (index < 0) {
        _categoryPath = [];
    } else {
        _categoryPath = _categoryPath.slice(0, index + 1);
    }
    _renderCategoryNav();
}

function aiCatStartChat() {
    if (_categoryPath.length === 0) return;
    var path = _categoryPath.map(function(p) { return p.name; }).join(' > ');
    var initEl = document.getElementById('ai-init-categories');
    if (initEl) {
        initEl.innerHTML = _buildBreadcrumb() + '<div>âœ… <strong>' + path + '</strong> ã§ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ææ¡ˆã‚’é–‹å§‹</div>';
    }
    var msg = 'ã€Œ' + path + 'ã€ã®ã‚«ãƒ†ã‚´ãƒªã§ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚';
    aiChatSend(msg);
}

function aiChatOmakase() {
    var initEl = document.getElementById('ai-init-categories');
    if (initEl) {
        initEl.innerHTML = 'ã¾ãšã¯ã©ã®ã‚¸ãƒ£ãƒ³ãƒ«ã§æ”»ã‚ãŸã„ã‹ã€ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ã¿ã¦ï¼<br><br>âœ… <strong>ãŠã¾ã‹ã›</strong> ã‚’é¸æŠ';
    }
    aiChatSend('ä½•ã§ã‚‚ã„ã„ã®ã§ã€æ„å¤–æ€§ã®ã‚ã‚‹ãƒ‹ãƒƒãƒãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãŠã¾ã‹ã›ã§ææ¡ˆã—ã¦ãã ã•ã„ã€‚ã‚¸ãƒ£ãƒ³ãƒ«ã¯å®Œå…¨ã«ã‚ãªãŸã«ãŠä»»ã›ã—ã¾ã™ã€‚');
}

function _buildMainCatGrid() {
    var cats = [
        ['DIYãƒ»å·¥å…·ãƒ»ã‚¬ãƒ¼ãƒ‡ãƒ³','ğŸ”§'], ['ãŠã‚‚ã¡ã‚ƒ','ğŸ§¸'],
        ['ã‚¹ãƒãƒ¼ãƒ„ï¼†ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢','â›º'], ['ãƒšãƒƒãƒˆç”¨å“','ğŸ¾'],
        ['ãƒ™ãƒ“ãƒ¼ï¼†ãƒã‚¿ãƒ‹ãƒ†ã‚£','ğŸ‘¶'], ['ãƒ›ãƒ¼ãƒ ï¼†ã‚­ãƒƒãƒãƒ³','ğŸ '],
        ['ãƒ›ãƒ“ãƒ¼','ğŸ¨'], ['æ–‡æˆ¿å…·ãƒ»ã‚ªãƒ•ã‚£ã‚¹ç”¨å“','âœï¸'],
        ['ç”£æ¥­ãƒ»ç ”ç©¶é–‹ç™ºç”¨å“','ğŸ”¬'], ['è»Šï¼†ãƒã‚¤ã‚¯','ğŸš—']
    ];
    var html = 'ã¾ãšã¯ã©ã®ã‚¸ãƒ£ãƒ³ãƒ«ã§æ”»ã‚ãŸã„ã‹ã€ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ã¿ã¦ï¼<div class="ai-cat-grid">';
    for (var i = 0; i < cats.length; i++) {
        var escaped = cats[i][0].replace(/'/g, "\\'");
        html += '<button type="button" class="ai-cat-btn" onclick="aiChatSelectCategory(\'' + escaped + '\')"><span class="ai-cat-emoji">' + cats[i][1] + '</span> ' + cats[i][0] + '</button>';
    }
    html += '</div><small style="color: #888;">ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ã‚‚ã„ã„ã—ã€è‡ªåˆ†ã§å…¥åŠ›ã—ã¦ã‚‚OKã ã‚ˆï¼</small>';
    return html;
}

async function expandKeyword(kw, btn) {
    // Toggle: if already expanded, close it
    var existing = btn.parentElement.querySelector('.kw-expand-result');
    if (existing) {
        existing.remove();
        btn.textContent = 'æ‹¡å¼µã™ã‚‹';
        return;
    }

    btn.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
    btn.disabled = true;

    var resultDiv = document.createElement('div');
    resultDiv.className = 'kw-expand-result';
    resultDiv.innerHTML = '<span class="ai-chat-loading"><span class="ai-chat-dot"></span><span class="ai-chat-dot"></span><span class="ai-chat-dot"></span></span>';
    btn.parentElement.appendChild(resultDiv);

    try {
        var response = await fetch('/research/discovery/keyword-expand', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ keyword: kw })
        });

        if (!response.ok) {
            resultDiv.innerHTML = '<small style="color:#991b1b;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</small>';
            btn.textContent = 'æ‹¡å¼µã™ã‚‹';
            btn.disabled = false;
            return;
        }

        var data = await response.json();
        var suggestions = data.suggestions || [];

        if (suggestions.length === 0) {
            resultDiv.innerHTML = '<small style="color:#666;">ã‚µã‚¸ã‚§ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</small>';
        } else {
            var html = '';
            for (var j = 0; j < suggestions.length; j++) {
                var ekw = suggestions[j];
                var eEscaped = ekw.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                var wordCount = ekw.trim().split(/\s+/).length;
                var canExpand = wordCount < 3;
                html += '<div class="kw-expand-item">' +
                        '<span class="ai-chat-kw-name">' + ekw + '</span>' +
                        ' <button class="btn btn-sm btn-primary ai-chat-keyword-btn" ' +
                        'onclick="useKeyword(\'' + eEscaped + '\')">ä½¿ã†</button>';
                if (canExpand) {
                    html += ' <button class="btn btn-sm ai-chat-expand-btn" ' +
                            'onclick="expandKeyword(\'' + eEscaped + '\', this)">æ‹¡å¼µã™ã‚‹</button>';
                }
                html += '</div>';
            }
            resultDiv.innerHTML = html;
        }

        btn.textContent = 'é–‰ã˜ã‚‹';
        btn.disabled = false;

    } catch(e) {
        resultDiv.innerHTML = '<small style="color:#991b1b;">é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</small>';
        btn.textContent = 'æ‹¡å¼µã™ã‚‹';
        btn.disabled = false;
    }
}

function aiChatReset() {
    aiChatHistory = [];
    _categoryPath = [];
    var container = document.getElementById('ai-chat-messages');
    container.innerHTML = '<div class="ai-chat-message ai-chat-assistant">' +
        '<div class="ai-chat-avatar ai-avatar-ai">AI</div>' +
        '<div class="ai-chat-bubble" id="ai-init-categories">' +
        _buildMainCatGrid() +
        '</div></div>';
}

var aiInput = document.getElementById('ai-chat-input');
aiInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        aiChatSend();
    }
});
aiInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 160) + 'px';
});
</script>
{% endif %}
{% endblock %}
