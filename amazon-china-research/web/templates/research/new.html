{% extends "base.html" %}
{% block title %}æ–°è¦ãƒªã‚µãƒ¼ãƒ{% endblock %}

{% block content %}
<h1>æ–°è¦ãƒªã‚µãƒ¼ãƒ</h1>

{% if error %}
<div class="alert alert-error">{{ error }}</div>
{% endif %}

{% if not session_ok %}
<div class="card" style="background: #fff3cd; border-left: 4px solid #dc3545; padding: 1rem; margin-bottom: 1rem;">
    <strong style="color: #dc3545;">1688æ¥ç¶šã‚¨ãƒ©ãƒ¼</strong>
    <p style="margin: 0.5rem 0 0 0;">{{ session_msg }}</p>
</div>
{% endif %}

{% if not usage_allowed %}
<div class="alert alert-error">{{ usage_message }}</div>
{% else %}
<div class="card">
    <form method="post" action="/research/new">
        <div class="form-group">
            <label for="keyword">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
            <div style="display: flex; gap: .5rem;">
                <input type="text" id="keyword" name="keyword" required autofocus
                       placeholder="ä¾‹ï¼šã‚¹ãƒãƒ›ã‚¹ã‚¿ãƒ³ãƒ‰" style="flex: 1;">
                <button type="button" class="btn btn-outline btn-sm" onclick="saveKeyword()"
                        title="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ä¿å­˜">&#9733; ä¿å­˜</button>
            </div>
            <small>Amazon-1688ã®ãƒªã‚µãƒ¼ãƒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</small>
        </div>

        <div class="form-group">
            <label for="mode">ãƒ¢ãƒ¼ãƒ‰</label>
            <select id="mode" name="mode" onchange="toggleAutoOptions()">
                <option value="single">ã‚·ãƒ³ã‚°ãƒ«ï¼ˆ1ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‰</option>
                <option value="auto">ã‚ªãƒ¼ãƒˆãƒªã‚µãƒ¼ãƒï¼ˆã‚µã‚¸ã‚§ã‚¹ãƒˆå±•é–‹ï¼‰</option>
            </select>
            <small>ã‚ªãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ã¯ã‚·ãƒ¼ãƒ‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‹ã‚‰Amazonã‚µã‚¸ã‚§ã‚¹ãƒˆã‚’ä½¿ã„ã€è¤‡æ•°ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è‡ªå‹•ãƒªã‚µãƒ¼ãƒã—ã¾ã™ã€‚</small>
        </div>

        <div id="auto-options" style="display:none;">
            <div class="form-group">
                <label for="auto_max_keywords">æœ€å¤§ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ•°</label>
                <input type="number" id="auto_max_keywords" name="auto_max_keywords"
                       value="10" min="2" max="100">
                <small>ãƒªã‚µãƒ¼ãƒã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æœ€å¤§æ•°</small>
            </div>
        </div>

        <button type="submit" class="btn btn-primary">ãƒªã‚µãƒ¼ãƒé–‹å§‹</button>
    </form>
    <p class="mt-1 text-muted">
        ä»Šæœˆã®ãƒªã‚µãƒ¼ãƒæ•°: {{ user.candidate_count_monthly }} / {{ user.candidate_limit_monthly }}
    </p>
</div>

<div class="card mt-1">
    <h2>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç™ºè¦‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</h2>
    <p class="text-muted" style="margin-bottom: .75rem;">ä½•ã‚’èª¿ã¹ã‚Œã°ã„ã„ã‹è¿·ã£ãŸã‚‰ã€ã“ã“ã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’é¸ã¹ã¾ã™ã€‚</p>
    <div class="discovery-tabs">
        <button class="discovery-tab active" data-tab="tab-categories"
                hx-get="/research/discovery/categories"
                hx-target="#discovery-content"
                hx-swap="innerHTML"
                hx-trigger="click, load">ğŸ“‚ ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰æ¢ã™</button>
        <button class="discovery-tab" data-tab="tab-random"
                hx-get="/research/discovery/random"
                hx-target="#discovery-content"
                hx-swap="innerHTML">ğŸ² ä»Šæ—¥ã®ãŠã™ã™ã‚</button>
        <button class="discovery-tab" data-tab="tab-successful"
                hx-get="/research/discovery/successful"
                hx-target="#discovery-content"
                hx-swap="innerHTML">ğŸ“Š å®Ÿç¸¾KW</button>
    </div>
    <div id="discovery-content" class="discovery-content">
        <div class="discovery-loading">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
</div>

{% if saved_keywords %}
<div class="card mt-1">
    <h2>ä¿å­˜æ¸ˆã¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</h2>
    <table class="table">
        <thead>
            <tr>
                <th>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</th>
                <th>ä¿å­˜æ—¥æ™‚</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
        {% for kw in saved_keywords %}
            <tr>
                <td>{{ kw.keyword }}</td>
                <td>{{ kw.created_at|jst }}</td>
                <td style="white-space: nowrap;">
                    <button class="btn btn-sm btn-primary" onclick="useKeyword('{{ kw.keyword }}')">ä½¿ç”¨</button>
                    <form method="post" action="/research/keywords/{{ kw.id }}/delete" style="display: inline;"
                          onsubmit="return confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')">
                        <button class="btn btn-sm btn-outline" type="submit">å‰Šé™¤</button>
                    </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<script>
function toggleAutoOptions() {
    var mode = document.getElementById('mode').value;
    document.getElementById('auto-options').style.display = mode === 'auto' ? 'block' : 'none';
}

function useKeyword(kw) {
    document.getElementById('keyword').value = kw;
    document.getElementById('keyword').focus();
}

// Discovery tab switching
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('discovery-tab')) {
        document.querySelectorAll('.discovery-tab').forEach(function(t) { t.classList.remove('active'); });
        e.target.classList.add('active');
    }
});

function saveKeyword() {
    var kw = document.getElementById('keyword').value.trim();
    if (!kw) { alert('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    var form = document.createElement('form');
    form.method = 'POST';
    form.action = '/research/keywords/save';
    var input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'keyword';
    input.value = kw;
    form.appendChild(input);
    document.body.appendChild(form);
    form.submit();
}
</script>
{% endif %}
{% endblock %}
