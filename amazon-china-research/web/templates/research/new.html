{% extends "base.html" %}
{% block title %}新規リサーチ{% endblock %}

{% block content %}
<h1>新規リサーチ</h1>

{% if error %}
<div class="alert alert-error">{{ error }}</div>
{% endif %}

{% if not usage_allowed %}
<div class="alert alert-error">{{ usage_message }}</div>
{% else %}
<div class="card">
    <form method="post" action="/research/new">
        <div class="form-group">
            <label for="keyword">キーワード</label>
            <div style="display: flex; gap: .5rem;">
                <input type="text" id="keyword" name="keyword" required autofocus
                       placeholder="例：スマホスタンド" style="flex: 1;">
                <button type="button" class="btn btn-outline btn-sm" onclick="saveKeyword()"
                        title="キーワードを保存">&#9733; 保存</button>
            </div>
            <small>Amazon-1688のリサーチキーワードを入力してください。</small>
        </div>

        <div class="form-group">
            <label for="mode">モード</label>
            <select id="mode" name="mode" onchange="toggleAutoOptions()">
                <option value="single">シングル（1キーワード）</option>
                <option value="auto">オートリサーチ（サジェスト展開）</option>
            </select>
            <small>オートモードはシードキーワードからAmazonサジェストを使い、複数キーワードを自動リサーチします。</small>
        </div>

        <div id="auto-options" style="display:none;">
            <div class="form-group">
                <label for="auto_max_keywords">最大キーワード数</label>
                <input type="number" id="auto_max_keywords" name="auto_max_keywords"
                       value="10" min="2" max="100">
                <small>リサーチするキーワードの最大数</small>
            </div>
        </div>

        <button type="submit" class="btn btn-primary">リサーチ開始</button>
    </form>
    <p class="mt-1 text-muted">
        今月のリサーチ数: {{ user.candidate_count_monthly }} / {{ user.candidate_limit_monthly }}
    </p>
</div>

<div class="card mt-1">
    <h2>キーワード発見アシスタント</h2>
    <p class="text-muted" style="margin-bottom: .75rem;">AIがあなたの思いつかないキーワードを提案します。何でも聞いてみてください。</p>

    <div class="ai-chat-container" id="ai-chat-messages">
        <div class="ai-chat-message ai-chat-assistant">
            <div class="ai-chat-avatar ai-avatar-ai">AI</div>
            <div class="ai-chat-bubble">
                どんな商品に興味がありますか？<br>
                例えば「キッチン用品」「アウトドア」など、ざっくりでOKです。<br>
                完全におまかせもできます！
            </div>
        </div>
    </div>

    <div class="ai-chat-input-area">
        <div style="display: flex; gap: .5rem; align-items: flex-end;">
            <textarea id="ai-chat-input" class="ai-chat-input"
                      placeholder="メッセージを入力..."
                      rows="2" autocomplete="off"></textarea>
            <button type="button" id="ai-chat-send" class="btn btn-primary ai-chat-send-btn" onclick="aiChatSend()">送信</button>
        </div>
        <div style="display: flex; gap: .5rem; margin-top: .5rem;">
            <button type="button" class="btn btn-outline btn-sm" onclick="aiChatOmakase()">おまかせで提案</button>
            <button type="button" class="btn btn-outline btn-sm" onclick="aiChatReset()">リセット</button>
        </div>
    </div>
</div>

{% if saved_keywords %}
<div class="card mt-1">
    <h2>保存済みキーワード</h2>
    <table class="table">
        <thead>
            <tr>
                <th>キーワード</th>
                <th>保存日時</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
        {% for kw in saved_keywords %}
            <tr>
                <td>{{ kw.keyword }}</td>
                <td>{{ kw.created_at|jst }}</td>
                <td style="white-space: nowrap;">
                    <button class="btn btn-sm btn-primary" onclick="useKeyword('{{ kw.keyword }}')">使用</button>
                    <form method="post" action="/research/keywords/{{ kw.id }}/delete" style="display: inline;"
                          onsubmit="return confirm('削除しますか？')">
                        <button class="btn btn-sm btn-outline" type="submit">削除</button>
                    </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<script>
function toggleAutoOptions() {
    var mode = document.getElementById('mode').value;
    document.getElementById('auto-options').style.display = mode === 'auto' ? 'block' : 'none';
}

function useKeyword(kw) {
    document.getElementById('keyword').value = kw;
    document.getElementById('keyword').focus();
    window.scrollTo({top: 0, behavior: 'smooth'});
}

function saveKeyword() {
    var kw = document.getElementById('keyword').value.trim();
    if (!kw) { alert('キーワードを入力してください'); return; }
    var form = document.createElement('form');
    form.method = 'POST';
    form.action = '/research/keywords/save';
    var input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'keyword';
    input.value = kw;
    form.appendChild(input);
    document.body.appendChild(form);
    form.submit();
}

/* --- AI Chat --- */
var aiChatHistory = [];
var aiChatBusy = false;

function aiChatScrollBottom() {
    var c = document.getElementById('ai-chat-messages');
    c.scrollTop = c.scrollHeight;
}

function aiChatAddMessage(role, html) {
    var container = document.getElementById('ai-chat-messages');
    var div = document.createElement('div');
    div.className = 'ai-chat-message ' + (role === 'user' ? 'ai-chat-user' : 'ai-chat-assistant');

    var avatar = document.createElement('div');
    avatar.className = 'ai-chat-avatar ' + (role === 'user' ? 'ai-avatar-you' : 'ai-avatar-ai');
    avatar.textContent = role === 'user' ? 'You' : 'AI';

    var bubble = document.createElement('div');
    bubble.className = 'ai-chat-bubble';
    bubble.innerHTML = html;

    div.appendChild(avatar);
    div.appendChild(bubble);
    container.appendChild(div);
    aiChatScrollBottom();
    return bubble;
}

function aiChatParseKeywords(text) {
    // Replace [KW]...[/KW] with keyword buttons
    return text.replace(/\[KW\](.*?)\[\/KW\]/g, function(match, kw) {
        var escaped = kw.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        return '<strong class="ai-chat-kw-name">' + kw + '</strong>' +
               ' <button class="btn btn-sm btn-primary ai-chat-keyword-btn" ' +
               'onclick="useKeyword(\'' + escaped + '\')"' +
               '>このキーワードを使う</button>';
    });
}

async function aiChatSend(overrideMessage) {
    if (aiChatBusy) return;

    var input = document.getElementById('ai-chat-input');
    var message = overrideMessage || input.value.trim();
    if (!message) return;

    aiChatBusy = true;
    input.value = '';
    document.getElementById('ai-chat-send').disabled = true;

    // Show user message
    aiChatAddMessage('user', message.replace(/</g, '&lt;').replace(/>/g, '&gt;'));

    // Show loading with typing dots
    var assistantBubble = aiChatAddMessage('assistant', '<span class="ai-chat-loading"><span class="ai-chat-dot"></span><span class="ai-chat-dot"></span><span class="ai-chat-dot"></span></span>');

    try {
        var response = await fetch('/research/discovery/ai-chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                message: message,
                history: aiChatHistory
            })
        });

        if (!response.ok) {
            assistantBubble.innerHTML = 'エラーが発生しました。もう一度お試しください。';
            aiChatBusy = false;
            document.getElementById('ai-chat-send').disabled = false;
            return;
        }

        var reader = response.body.getReader();
        var decoder = new TextDecoder();
        var fullText = '';
        assistantBubble.innerHTML = '';

        while (true) {
            var result = await reader.read();
            if (result.done) break;

            var text = decoder.decode(result.value, {stream: true});
            var lines = text.split('\n');

            for (var i = 0; i < lines.length; i++) {
                var line = lines[i].trim();
                if (!line.startsWith('data: ')) continue;

                try {
                    var data = JSON.parse(line.substring(6));
                    if (data.done) break;
                    if (data.error) {
                        assistantBubble.innerHTML = data.error;
                        break;
                    }
                    if (data.chunk) {
                        fullText += data.chunk;
                        // Render with line breaks and keyword parsing
                        assistantBubble.innerHTML = aiChatParseKeywords(
                            fullText.replace(/</g, '&lt;').replace(/>/g, '&gt;')
                                    .replace(/\n/g, '<br>')
                        );
                        aiChatScrollBottom();
                    }
                } catch(e) { /* ignore parse errors for partial chunks */ }
            }
        }

        // Final render with keyword buttons
        assistantBubble.innerHTML = aiChatParseKeywords(
            fullText.replace(/</g, '&lt;').replace(/>/g, '&gt;')
                    .replace(/\n/g, '<br>')
        );

        // Update history
        aiChatHistory.push({role: 'user', content: message});
        aiChatHistory.push({role: 'assistant', content: fullText});

    } catch(e) {
        assistantBubble.innerHTML = '通信エラーが発生しました。もう一度お試しください。';
    }

    aiChatBusy = false;
    document.getElementById('ai-chat-send').disabled = false;
    input.focus();
}

function aiChatOmakase() {
    aiChatSend('何でもいいので、意外性のあるニッチなキーワードをおまかせで提案してください。ジャンルは完全にあなたにお任せします。');
}

function aiChatReset() {
    aiChatHistory = [];
    var container = document.getElementById('ai-chat-messages');
    container.innerHTML = '<div class="ai-chat-message ai-chat-assistant">' +
        '<div class="ai-chat-avatar ai-avatar-ai">AI</div>' +
        '<div class="ai-chat-bubble">' +
        'どんな商品に興味がありますか？<br>' +
        '例えば「キッチン用品」「アウトドア」など、ざっくりでOKです。<br>' +
        '完全におまかせもできます！' +
        '</div></div>';
}

// Enter key to send (Shift+Enter for newline)
var aiInput = document.getElementById('ai-chat-input');
aiInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        aiChatSend();
    }
});
// Auto-resize textarea
aiInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 160) + 'px';
});
</script>
{% endif %}
{% endblock %}
