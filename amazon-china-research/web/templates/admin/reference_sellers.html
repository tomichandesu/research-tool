{% extends "base.html" %}
{% block title %}å‚è€ƒã‚»ãƒ©ãƒ¼ç®¡ç† - ç®¡ç†{% endblock %}

{% block content %}
<h1>å‚è€ƒã‚»ãƒ©ãƒ¼ç®¡ç†</h1>
<a href="/admin/" class="btn btn-sm btn-outline">&larr; æˆ»ã‚‹</a>

{% if error %}
<div class="card mt-1" style="background: #f8d7da; border-left: 4px solid #dc3545; padding: 1rem;">
    <strong style="color: #dc3545;">{{ error }}</strong>
</div>
{% endif %}

{% if success %}
<div class="card mt-1" style="background: #d4edda; border-left: 4px solid #28a745; padding: 1rem;">
    <strong style="color: #155724;">{{ success }}</strong>
</div>
{% endif %}

<div class="card mt-1">
    <h2>ã‚»ãƒ©ãƒ¼è¿½åŠ </h2>
    <p style="color: #666; font-size: 0.9em; margin-bottom: 1rem;">
        å‚è€ƒã«ã™ã‚‹å„ªç§€ãªä¸­å›½è¼¸å…¥ã‚»ãƒ©ãƒ¼ã®URLã‚’ç™»éŒ²ã—ã¾ã™ã€‚<br>
        <strong>å•†å“ãƒšãƒ¼ã‚¸URL</strong>ã§ã‚‚OKï¼ˆè‡ªå‹•çš„ã«ã‚»ãƒ©ãƒ¼ã‚’ç‰¹å®šã—ã¾ã™ï¼‰ã€‚<br>
        è¤‡æ•°URLã‚’ã¾ã¨ã‚ã¦è²¼ã‚Šä»˜ã‘ã§ãã¾ã™ï¼ˆ1è¡Œ1URLï¼‰ã€‚<br>
        ä¸­å›½ãƒ»ã‚¢ãƒ¡ãƒªã‚«ç­‰ã®æµ·å¤–ã‚»ãƒ©ãƒ¼ã¯è‡ªå‹•çš„ã«é™¤å¤–ã•ã‚Œã¾ã™ã€‚<br>
        ç™»éŒ²å¾Œã«ã€Œã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã€ã§å•†å“ã‚¿ã‚¤ãƒˆãƒ«ã‚’è‡ªå‹•å–å¾—ã§ãã¾ã™ã€‚
    </p>
    <form method="post" action="/admin/reference-sellers">
        <div style="margin-bottom: 0.75rem;">
            <label style="font-weight: bold; display: block; margin-bottom: 4px;">Amazon ã‚»ãƒ©ãƒ¼URLï¼ˆ1è¡Œ1URLã€è¤‡æ•°å¯ï¼‰</label>
            <textarea name="urls" rows="5" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em; font-family: monospace;" placeholder="https://www.amazon.co.jp/dp/B0XXXXXï¼ˆå•†å“ãƒšãƒ¼ã‚¸URLï¼‰&#10;https://www.amazon.co.jp/s?me=YYYYYï¼ˆã‚»ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸URLï¼‰&#10;ã©ã¡ã‚‰ã®å½¢å¼ã§ã‚‚OK" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">è¿½åŠ </button>
    </form>
</div>

<div class="card mt-1">
    <h2>ç™»éŒ²æ¸ˆã¿ã‚»ãƒ©ãƒ¼ï¼ˆ{{ sellers|length }}ä»¶ï¼‰</h2>
    {% if sellers %}
    <div style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
        <label style="cursor: pointer; user-select: none;">
            <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"> å…¨é¸æŠ
        </label>
        <button type="button" class="btn btn-sm btn-primary" id="bulkScrapeBtn"
                style="padding: 2px 12px; display: none;"
                onclick="submitBulkScrape()">
            ä¸€æ‹¬ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆ<span id="scrapeCount">0</span>ä»¶ï¼‰
        </button>
        <button type="button" class="btn btn-sm" id="bulkDeleteBtn"
                style="background: #d32f2f; color: #fff; border: none; padding: 2px 12px; cursor: pointer; display: none;"
                onclick="submitBulkDelete()">
            é¸æŠå‰Šé™¤ï¼ˆ<span id="selectedCount">0</span>ä»¶ï¼‰
        </button>
    </div>
    <div id="scrapeProgress" style="display: none; margin-bottom: 0.5rem; padding: 0.5rem 1rem; background: #e3f2fd; border-radius: 4px;">
        <span id="scrapeStatus">å‡¦ç†ä¸­...</span>
        <div style="background: #ccc; border-radius: 4px; height: 6px; margin-top: 4px;">
            <div id="scrapeBar" style="background: #1976d2; height: 6px; border-radius: 4px; width: 0%; transition: width 0.3s;"></div>
        </div>
    </div>
    <table class="table">
        <thead>
            <tr>
                <th style="width: 30px;"></th>
                <th>ã‚»ãƒ©ãƒ¼å</th>
                <th>URL</th>
                <th>å•†å“æ•°</th>
                <th>æœ€çµ‚å–å¾—æ—¥</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
        {% for s in sellers %}
            <tr{% if '[ä¸æ˜]' in s.name %} style="background: #fff3cd;"{% endif %}>
                <td><input type="checkbox" data-id="{{ s.id }}" class="seller-cb" onchange="updateBulkBtn()"></td>
                <td style="font-weight: bold;">
                    {{ s.name }}
                    {% if '[ä¸æ˜]' in s.name %}
                    <span style="color: #856404; font-size: 0.8em;">ï¼ˆæ‰€åœ¨åœ°æœªç¢ºèªï¼‰</span>
                    {% elif '[JP]' in s.name %}
                    <span style="color: #155724; font-size: 0.8em;">ğŸ‡¯ğŸ‡µ</span>
                    {% endif %}
                </td>
                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    <a href="{{ s.url }}" target="_blank" rel="noopener">{{ s.url[:60] }}{% if s.url|length > 60 %}...{% endif %}</a>
                </td>
                <td>{{ s.product_count }}ä»¶</td>
                <td>{{ s.scraped_at|jst if s.scraped_at else 'æœªå–å¾—' }}</td>
                <td style="white-space: nowrap;">
                    <form method="post" action="/admin/reference-sellers/{{ s.id }}/scrape" style="display: inline;">
                        <button class="btn btn-sm btn-primary" style="padding: 2px 8px;">ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°</button>
                    </form>
                    <button type="button" class="btn btn-sm" style="background: #ff9800; color: #fff; border: none; padding: 2px 8px; cursor: pointer;"
                            onclick="toggleManual({{ s.id }})">æ‰‹å‹•å…¥åŠ›</button>
                </td>
            </tr>
            <tr id="manual-{{ s.id }}" style="display: none;">
                <td colspan="6">
                    <form method="post" action="/admin/reference-sellers/{{ s.id }}/manual">
                        <label style="font-weight: bold; display: block; margin-bottom: 4px;">å•†å“ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ1è¡Œ1ã‚¿ã‚¤ãƒˆãƒ«ï¼‰</label>
                        <textarea name="titles" rows="6" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em; font-family: monospace;" placeholder="å•†å“ã‚¿ã‚¤ãƒˆãƒ«1&#10;å•†å“ã‚¿ã‚¤ãƒˆãƒ«2&#10;å•†å“ã‚¿ã‚¤ãƒˆãƒ«3">{% if s.products_json %}{% for t in s.products_json|from_json %}{{ t }}{% if not loop.last %}&#10;{% endif %}{% endfor %}{% endif %}</textarea>
                        <button type="submit" class="btn btn-primary" style="margin-top: 0.5rem;">ä¿å­˜</button>
                    </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #888;">å‚è€ƒã‚»ãƒ©ãƒ¼ã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
    {% endif %}
</div>

<script>
function toggleManual(id) {
    var row = document.getElementById('manual-' + id);
    row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
}
function toggleSelectAll(el) {
    var cbs = document.querySelectorAll('.seller-cb');
    for (var i = 0; i < cbs.length; i++) { cbs[i].checked = el.checked; }
    updateBulkBtn();
}
function updateBulkBtn() {
    var checked = document.querySelectorAll('.seller-cb:checked').length;
    document.getElementById('selectedCount').textContent = checked;
    document.getElementById('scrapeCount').textContent = checked;
    document.getElementById('bulkDeleteBtn').style.display = checked > 0 ? 'inline-block' : 'none';
    document.getElementById('bulkScrapeBtn').style.display = checked > 0 ? 'inline-block' : 'none';
    var all = document.querySelectorAll('.seller-cb').length;
    document.getElementById('selectAll').checked = (checked === all && all > 0);
}
function submitBulkDelete() {
    var cbs = document.querySelectorAll('.seller-cb:checked');
    if (cbs.length === 0) return;
    if (!confirm(cbs.length + 'ä»¶ã®ã‚»ãƒ©ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    var form = document.createElement('form');
    form.method = 'post';
    form.action = '/admin/reference-sellers/bulk-delete';
    for (var i = 0; i < cbs.length; i++) {
        var input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'ids';
        input.value = cbs[i].getAttribute('data-id');
        form.appendChild(input);
    }
    document.body.appendChild(form);
    form.submit();
}
async function submitBulkScrape() {
    var cbs = document.querySelectorAll('.seller-cb:checked');
    if (cbs.length === 0) return;
    if (!confirm(cbs.length + 'ä»¶ã®ã‚»ãƒ©ãƒ¼ã‚’ä¸€æ‹¬ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆ1ä»¶ãšã¤é †ç•ªã«å®Ÿè¡Œã—ã¾ã™ï¼‰')) return;

    var ids = [];
    for (var i = 0; i < cbs.length; i++) { ids.push(cbs[i].getAttribute('data-id')); }

    // Disable buttons
    document.getElementById('bulkScrapeBtn').disabled = true;
    document.getElementById('bulkDeleteBtn').disabled = true;
    document.getElementById('selectAll').disabled = true;
    document.querySelectorAll('.seller-cb').forEach(function(cb) { cb.disabled = true; });

    // Show progress
    var prog = document.getElementById('scrapeProgress');
    var status = document.getElementById('scrapeStatus');
    var bar = document.getElementById('scrapeBar');
    prog.style.display = 'block';

    var done = 0, ok = 0, fail = 0, deleted = 0;
    for (var i = 0; i < ids.length; i++) {
        status.textContent = 'å‡¦ç†ä¸­... ' + (i+1) + '/' + ids.length;
        bar.style.width = Math.round((i / ids.length) * 100) + '%';
        try {
            var resp = await fetch('/admin/reference-sellers/' + ids[i] + '/scrape', {
                method: 'POST',
                headers: {'X-Requested-With': 'XMLHttpRequest'}
            });
            var text = await resp.text();
            if (text.indexOf('è‡ªå‹•å‰Šé™¤') !== -1) { deleted++; }
            else if (text.indexOf('ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å¤±æ•—') !== -1) { fail++; }
            else { ok++; }
        } catch(e) { fail++; }
        done++;
    }

    bar.style.width = '100%';
    var msg = done + 'ä»¶å®Œäº†';
    if (ok > 0) msg += ' / æˆåŠŸ: ' + ok + 'ä»¶';
    if (deleted > 0) msg += ' / æµ·å¤–ã‚»ãƒ©ãƒ¼å‰Šé™¤: ' + deleted + 'ä»¶';
    if (fail > 0) msg += ' / å¤±æ•—: ' + fail + 'ä»¶';
    status.textContent = msg + ' â€” ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™...';

    setTimeout(function() { location.reload(); }, 1500);
}
</script>
{% endblock %}
